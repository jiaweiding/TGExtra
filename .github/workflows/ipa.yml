name: Build and Release IPA

on:
  workflow_dispatch:
    inputs:
      telegram_variant:
        description: 'Telegram variant to build'
        required: true
        type: choice
        options:
          - swiftgram
          - turrit
          - telegram
      decrypted_ipa_url:
        description: 'Direct URL of the decrypted IPA'
        required: true
        type: string
      inject_sideload_fix:
        description: 'Inject SideloadFix.dylib'
        required: false
        type: boolean
        default: true
      inject_nse_fix:
        description: 'Inject NSEFix.dylib'
        required: false
        type: boolean
        default: true
      tgextra_version:
        description: 'Version of TGExtra to use (e.g., 1.7.1)'
        required: true
        type: string

jobs:
  prepareDependencies:
    name: Prepare Dependencies
    runs-on: macos-14
    outputs:
      ipa_app_name: ${{ steps.extractIPA.outputs.ipa_app_name }}
      ipa_bundle_id: ${{ steps.extractIPA.outputs.ipa_bundle_id }}
      ipa_version: ${{ steps.extractIPA.outputs.ipa_version }}
      variant_name: ${{ steps.setVariant.outputs.variant_name }}
      ipa_source: ${{ steps.setVariant.outputs.ipa_source }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set variant information
        id: setVariant
        run: |
          case "${{ inputs.telegram_variant }}" in
            swiftgram)
              echo "variant_name=Swiftgram" >> "$GITHUB_OUTPUT"
              echo "ipa_source=https://github.com/Swiftgram/Swiftgram" >> "$GITHUB_OUTPUT"
              ;;
            turrit)
              echo "variant_name=Turrit" >> "$GITHUB_OUTPUT"
              echo "ipa_source=https://github.com/Turrit-Telegram/Turrit" >> "$GITHUB_OUTPUT"
              ;;
            telegram)
              echo "variant_name=Telegram" >> "$GITHUB_OUTPUT"
              echo "ipa_source=https://github.com/TelegramMessenger/Telegram-iOS" >> "$GITHUB_OUTPUT"
              ;;
          esac

      - name: Download decrypted IPA
        env:
          IPA_URL: ${{ inputs.decrypted_ipa_url }}
        run: |
          # Normalize Dropbox URLs: change dl=0 to dl=1
          NORMALIZED_URL=$(echo "$IPA_URL" | sed 's/dl=0/dl=1/g')
          echo "Downloading IPA from: $NORMALIZED_URL"
          curl -L -A "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)" -o decrypted.ipa "$NORMALIZED_URL"
          unzip -q decrypted.ipa


      - name: Extract Name, Bundle ID, and Version
        id: extractIPA
        run: |
          PLIST=$(ls Payload/*.app/Info.plist | head -n1)

          IPA_APP_NAME=$(grep -A1 '<key>CFBundleDisplayName</key>' "$PLIST" | sed -n 's/.*<string>\(.*\)<\/string>.*/\1/p' || grep -A1 '<key>CFBundleExecutable</key>' "$PLIST" | sed -n 's/.*<string>\(.*\)<\/string>.*/\1/p' || grep -A1 '<key>CFBundleName</key>' "$PLIST" | sed -n 's/.*<string>\(.*\)<\/string>.*/\1/p')
          IPA_BUNDLE_ID=$(grep -A1 '<key>CFBundleIdentifier</key>' "$PLIST" | sed -n 's/.*<string>\(.*\)<\/string>.*/\1/p')
          IPA_VERSION=$(grep -A1 '<key>CFBundleShortVersionString</key>' "$PLIST" | sed -n 's/.*<string>\(.*\)<\/string>.*/\1/p')

          echo "ipa_app_name=$IPA_APP_NAME" >> "$GITHUB_OUTPUT"
          echo "ipa_bundle_id=$IPA_BUNDLE_ID" >> "$GITHUB_OUTPUT"
          echo "ipa_version=$IPA_VERSION" >> "$GITHUB_OUTPUT"

      - name: Download or use local SideloadFix.dylib
        if: ${{ inputs.inject_sideload_fix }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f lib/SideloadFix.dylib ]; then
            echo "Using local SideloadFix.dylib from lib directory"
            cp lib/SideloadFix.dylib .
          else
            echo "Downloading SideloadFix.dylib from GitHub"
            gh release download release --repo TheWinner02/SideloadFix --pattern 'SideloadFix.dylib' --dir .
          fi

      - name: Download or use local NSEFix.dylib
        if: ${{ inputs.inject_nse_fix }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f lib/NSEFix.dylib ]; then
            echo "Using local NSEFix.dylib from lib directory"
            cp lib/NSEFix.dylib .
          else
            echo "Downloading NSEFix.dylib from GitHub"
            gh release download release --repo TheWinner02/NSEFix --pattern 'NSEFix.dylib' --dir .
          fi

      - name: Extract TGExtra.dylib from .deb or use existing .dylib
        run: |
          VERSION="${{ inputs.tgextra_version }}"
          echo "Looking for TGExtra version: $VERSION"
          
          # Check for dylib or deb matching version precisely
          # Uses regex to ensure the version is not followed by a digit or a dot+digit
          FILES=$(ls lib/ 2>/dev/null)
          DYLIB_NAME=$(echo "$FILES" | grep -i "TGExtra" | grep "\.dylib$" | grep -E "(^|[^0-9])$VERSION([^0-9]|\.[^0-9]|$)" | head -n1)
          DEB_NAME=$(echo "$FILES" | grep -i "TGExtra" | grep "\.deb$" | grep -E "(^|[^0-9])$VERSION([^0-9]|\.[^0-9]|$)" | head -n1)
          
          if [ -n "$DYLIB_NAME" ]; then
            DYLIB_FILE="lib/$DYLIB_NAME"
            echo "Found matching TGExtra dylib: $DYLIB_FILE"
            cp "$DYLIB_FILE" lib/TGExtra.dylib
          elif [ -n "$DEB_NAME" ]; then
            DEB_FILE="lib/$DEB_NAME"
            echo "Found matching TGExtra deb: $DEB_FILE, extracting..."
            mkdir -p deb-extract-tgextra
            if command -v brew >/dev/null; then brew install zstd; fi
            
            ar x "$DEB_FILE"
            if [ -f data.tar.zst ]; then
              zstd -d data.tar.zst
              tar -xf data.tar -C deb-extract-tgextra
            else
              tar -xf data.tar.* -C deb-extract-tgextra
            fi
            
            EXTRACTED_DYLIB=$(find deb-extract-tgextra -name "*.dylib" | head -n 1)
            if [ -z "$EXTRACTED_DYLIB" ]; then
              echo "Error: No .dylib found in $DEB_FILE"
              exit 1
            fi
            cp "$EXTRACTED_DYLIB" lib/TGExtra.dylib
            rm -rf deb-extract-tgextra *.tar* debian-binary
          else
            echo "Error: No TGExtra dylib or deb found matching version $VERSION in lib/ directory."
            ls lib/
            exit 1
          fi

      - name: Extract SwiftgramPro.dylib if building Swiftgram
        if: ${{ inputs.telegram_variant == 'swiftgram' }}
        run: |
          # Check if .dylib exists directly
          if [ -f lib/SwiftgramPro.dylib ]; then
            echo "Using SwiftgramPro.dylib from lib directory"
          # Check if .deb file exists
          elif ls lib/SwiftgramPro*.deb 1> /dev/null 2>&1; then
            echo "Found SwiftgramPro .deb file, extracting dylib..."
            SWIFTGRAMPRO_DEB=$(ls lib/SwiftgramPro*.deb | head -n1)
            mkdir -p deb-extract-swiftgrampro
            
            # Extract data.tar.*
            ar x "$SWIFTGRAMPRO_DEB"
            if [ -f data.tar.zst ]; then
              if ! command -v zstd >/dev/null; then if command -v brew >/dev/null; then brew install zstd; fi; fi
              zstd -d data.tar.zst
              tar -xf data.tar -C deb-extract-swiftgrampro
            else
              tar -xf data.tar.* -C deb-extract-swiftgrampro
            fi
            
            # Find the dylib in the extracted files
            DYLIB_PATH=$(find deb-extract-swiftgrampro -name "*.dylib" | head -n 1)
            if [ -z "$DYLIB_PATH" ]; then
              echo "Warning: No .dylib found in $SWIFTGRAMPRO_DEB. Files found:"
              find deb-extract-swiftgrampro -maxdepth 4
              echo "Swiftgram will be built without Pro features"
            else
              cp "$DYLIB_PATH" lib/SwiftgramPro.dylib
              echo "Extracted SwiftgramPro.dylib from $SWIFTGRAMPRO_DEB"
            fi
            rm -rf deb-extract-swiftgrampro *.tar* debian-binary
          else
            echo "Warning: Neither SwiftgramPro.dylib nor SwiftgramPro*.deb found in lib directory"
            echo "Swiftgram will be built without Pro features"
          fi

      - name: Upload Dependencies
        uses: actions/upload-artifact@v4
        with:
          name: dependencies
          path: |
            decrypted.ipa
            TGExtra.bundle
            lib/TGExtra.dylib
            SideloadFix.dylib
            NSEFix.dylib
            SwiftgramPro.dylib

  inject:
    name: Inject Dylibs
    needs: prepareDependencies
    runs-on: macos-14
    env:
      IPA_BUNDLE_ID: ${{ needs.prepareDependencies.outputs.ipa_bundle_id }}
      IPA_VERSION: ${{ needs.prepareDependencies.outputs.ipa_version }}
      VARIANT_NAME: ${{ needs.prepareDependencies.outputs.variant_name }}
      INJECT_SIDELOAD_FIX: ${{ inputs.inject_sideload_fix }}
      INJECT_NSE_FIX: ${{ inputs.inject_nse_fix }}
      TELEGRAM_VARIANT: ${{ inputs.telegram_variant }}
    steps:
      - name: Download dependencies
        uses: actions/download-artifact@v4
        with:
          path: dependencies
          name: dependencies
          merge-multiple: true

      - name: Install insert_dylib
        run: |
          git clone https://github.com/Tyilo/insert_dylib.git
          cc insert_dylib/insert_dylib/main.c -o insert_dylib_bin
          sudo mv insert_dylib_bin /usr/local/bin/insert_dylib

      - name: Install ldid
        run: |
          brew install ldid

      - name: Inject dylibs into IPA
        run: |
          set -e

          DECRYPTED_IPA="dependencies/decrypted.ipa"
          TGEXTRA_BUNDLE="dependencies/TGExtra.bundle"
          TGEXTRA_DYLIB="dependencies/lib/TGExtra.dylib"

          OUT_BASE="$IPA_BUNDLE_ID-$IPA_VERSION-TGExtra"
          OUT_IPA="$OUT_BASE.ipa"
          OUT_TIPA="$OUT_BASE.tipa"
          TMP_DIR="tmp-ipa"

          mkdir -p artifacts

          unzip "$DECRYPTED_IPA" -d "$TMP_DIR"
          APP_PATH=$(find "$TMP_DIR/Payload" -type d -name "*.app" | head -n 1)
          PLIST="$APP_PATH/Info.plist"
          EXECUTABLE_NAME=$(/usr/libexec/PlistBuddy -c "Print :CFBundleExecutable" "$PLIST")
          BIN_PATH="$APP_PATH/$EXECUTABLE_NAME"

          mkdir -p "$APP_PATH/Frameworks"
          
          # Inject TGExtra.dylib
          echo "Injecting TGExtra.dylib..."
          cp "$TGEXTRA_DYLIB" "$APP_PATH/Frameworks/TGExtra.dylib"
          insert_dylib --all-yes @executable_path/Frameworks/TGExtra.dylib "$BIN_PATH"
          mv "$BIN_PATH"_patched "$BIN_PATH"
          
          # Inject SideloadFix.dylib if enabled
          if [ "$INJECT_SIDELOAD_FIX" = "true" ] && [ -f "dependencies/SideloadFix.dylib" ]; then
            echo "Injecting SideloadFix.dylib..."
            cp "dependencies/SideloadFix.dylib" "$APP_PATH/Frameworks/SideloadFix.dylib"
            insert_dylib --all-yes @executable_path/Frameworks/SideloadFix.dylib "$BIN_PATH"
            mv "$BIN_PATH"_patched "$BIN_PATH"
          fi
          
          # Inject NSEFix.dylib if enabled
          if [ "$INJECT_NSE_FIX" = "true" ] && [ -f "dependencies/NSEFix.dylib" ]; then
            echo "Injecting NSEFix.dylib..."
            cp "dependencies/NSEFix.dylib" "$APP_PATH/Frameworks/NSEFix.dylib"
            insert_dylib --all-yes @executable_path/Frameworks/NSEFix.dylib "$BIN_PATH"
            mv "$BIN_PATH"_patched "$BIN_PATH"
          fi
          
          # Inject SwiftgramPro.dylib for Swiftgram variant
          if [ "$TELEGRAM_VARIANT" = "swiftgram" ] && [ -f "dependencies/SwiftgramPro.dylib" ]; then
            echo "Injecting SwiftgramPro.dylib for Swiftgram variant..."
            cp "dependencies/SwiftgramPro.dylib" "$APP_PATH/Frameworks/SwiftgramPro.dylib"
            insert_dylib --all-yes @executable_path/Frameworks/SwiftgramPro.dylib "$BIN_PATH"
            mv "$BIN_PATH"_patched "$BIN_PATH"
          fi

          # Copy TGExtra.bundle
          cp -R "$TGEXTRA_BUNDLE" "$APP_PATH/"

          # Sign the binary
          ldid -S "$BIN_PATH"

          # Verify injections
          echo "Verifying dylib injections:"
          otool -L "$BIN_PATH" | grep -E "(TGExtra.dylib|SideloadFix.dylib|NSEFix.dylib|SwiftgramPro.dylib)" || echo "No dylibs found in binary"

          # Package IPA
          (cd "$TMP_DIR" && zip -qr "../$OUT_IPA" .)
          cp "$OUT_IPA" "artifacts/$OUT_IPA"
          cp "$OUT_IPA" "artifacts/$OUT_TIPA"
          
          rm -rf "$TMP_DIR"

      - name: Upload injected IPA
        uses: actions/upload-artifact@v4
        with:
          name: injected-artifacts
          path: |
            artifacts/*.ipa
            artifacts/*.tipa

  patch:
    name: Patch injected IPA
    needs: [prepareDependencies, inject]
    runs-on: macos-14
    env:
      IPA_BUNDLE_ID: ${{ needs.prepareDependencies.outputs.ipa_bundle_id }}
      IPA_VERSION: ${{ needs.prepareDependencies.outputs.ipa_version }}
    steps:
      - name: Download injected IPA
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          name: injected-artifacts
          merge-multiple: true

      - name: Install ipapatch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=$(gh api repos/asdfzxcvbn/ipapatch/releases/latest --jq .tag_name)
          ARCH=$(uname -m)
          if [[ "$ARCH" == "arm64" ]]; then
            ASSET="ipapatch.macos-arm64"
          else
            ASSET="ipapatch.macos-amd64"
          fi

          gh release download "$TAG" --repo asdfzxcvbn/ipapatch --pattern "$ASSET" --dir .

          mkdir -p bin
          mv "$ASSET" bin/ipapatch
          chmod +x bin/ipapatch
          echo "PATH=$GITHUB_WORKSPACE/bin:$PATH" >> $GITHUB_ENV

      - name: Patch injected IPA
        run: |
          OUT_BASE="$IPA_BUNDLE_ID-$IPA_VERSION-TGExtra"
          INJECTED_IPA="artifacts/$OUT_BASE.ipa"
          INJECTED_TIPA="artifacts/$OUT_BASE.tipa"

          ipapatch --input "$INJECTED_IPA" --inplace --noconfirm
          ipapatch --input "$INJECTED_TIPA" --inplace --noconfirm

      - name: Upload patched IPA
        uses: actions/upload-artifact@v4
        with:
          name: patched-artifacts
          path: |
            artifacts/*.ipa
            artifacts/*.tipa



  cleanup:
    name: Cleanup
    needs: [patch]
    runs-on: macos-14
    steps:
      - name: Delete build artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            dependencies
            injected-artifacts
          failOnError: false
